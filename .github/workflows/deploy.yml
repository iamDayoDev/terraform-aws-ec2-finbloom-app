name: deploy apply

on:
  push:
    branches:
      - main
    paths:
      - 'Backend/**'
      - 'Frontend/**'
      - '.github/workflows/deploy.yml'
  pull_request:
    branches:
      - main
    paths:
      - 'Backend/**'
      - 'Frontend/**'
      - '.github/workflows/deploy.yml'

  workflow_dispatch:

permissions:
  id-token: write   # This is required for requesting the JWT
  contents: read

env:
  REPO_DIR: /home/ubuntu/terraform-aws-ec2-finbloom-app
  # BACKEND_DIR: ${{ env.REPO_DIR }}/Backend
  # FRONTEND_DIR: ${{ env.REPO_DIR }}/Frontend
  

jobs:
  deployBackend:
    name: 'Deploy Backend Service'
    runs-on: ubuntu-latest

    steps:
      - name: 'Checkout GitHub Action'
        uses: actions/checkout@v3

      - name: 'Configure AWS Credentials'
        uses: aws-actions/configure-aws-credentials@v2
        with:
          role-to-assume: ${{ secrets.AWS_IAM_ROLE }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Test AWS Credentials
        run: aws sts get-caller-identity

      - name: Set up SSH key
        run: |
          echo "${{ secrets.EC2_SSH_KEY }}" > hng_devops.pem
          chmod 600 hng_devops.pem

      - name: SSH into EC2 and deploy
        run: |
          ssh -o StrictHostKeyChecking=no -i hng_devops.pem ubuntu@${{ secrets.BACKEND_PUBLIC_IP }} "
            echo "Starting backend service deployment"
            sudo apt update -y
            curl -fsSL https://deb.nodesource.com/setup_20.x | sudo -E bash -
            sudo apt install -y nodejs
            ## Verify Node.js installation
            node -v
            npm -v
            ## Install backend dependencies and start the service
            sudo npm install -g pm2
            sudo apt install postgresql-client -y
          "

      - name: 'Clone Project Repository'
        run: |
          ssh -o StrictHostKeyChecking=no -i hng_devops.pem ubuntu@${{ secrets.BACKEND_PUBLIC_IP }} "
            echo "Cloning Project Repo"
             echo "Cloning application repository"
            git clone https://github.com/iamDayoDev/terraform-aws-ec2-finbloom-app.git || echo "Repository already cloned"
            cd "${REPO_DIR}"
            "

      - name: Apply database schema via SSH
        run: |
          ssh -o StrictHostKeyChecking=no -i hng_devops.pem ubuntu@${{ secrets.BACKEND_PUBLIC_IP }} "
            echo 'Applying database schema'
            export PGPASSWORD='${{ secrets.DB_PASSWORD }}'
            psql -h '${{ secrets.DB_HOST }}' -U '${{ secrets.DB_USER }}' -d '${{ secrets.DB_NAME }}' -f /home/ubuntu/terraform-aws-ec2-finbloom-app/Backend/schema.sql || echo 'âŒ Failed to apply DB schema'
          "

      - name: Start Backend Service
        run: |
          ssh -o StrictHostKeyChecking=no -i hng_devops.pem ubuntu@${{ secrets.BACKEND_PUBLIC_IP }} "
            echo "Starting backend service"
            cd /home/ubuntu/terraform-aws-ec2-finbloom-app/Backend
            pm2 restart backend || pm2 start server.js --name backend
          "

      - name: Summary
        run: echo "### ðŸš€ Backend Server Deployment Completed" >> $GITHUB_STEP_SUMMARY

  deployFrontend:
    needs: deployBackend
    name: 'Deploy to Frontend Server'
    runs-on: ubuntu-latest

    steps:
      - name: Set derived paths
        run: |
          echo "BACKEND_DIR=$REPO_DIR/Backend" >> $GITHUB_ENV
          echo "FRONTEND_DIR=$REPO_DIR/Frontend" >> $GITHUB_ENV

      - name: 'Checkout GitHub Action'
        uses: actions/checkout@v3

      - name: 'Configure AWS Credentials'
        uses: aws-actions/configure-aws-credentials@v2
        with:
          role-to-assume: ${{ secrets.AWS_IAM_ROLE }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Test AWS Credentials
        run: aws sts get-caller-identity

      - name: Set up SSH key
        run: |
          echo "${{ secrets.EC2_SSH_KEY }}" > hng_devops.pem
          chmod 600 hng_devops.pem

      - name: SSH into EC2 and deploy
        run: |
          ssh -o StrictHostKeyChecking=no -i hng_devops.pem ubuntu@${{ secrets.FRONTEND_PUBLIC_IP }} "
            echo "Connected to EC2 instance"
            ## Add your deployment commands here
            sudo apt update -y
            sudo apt install -y nginx
            sudo systemctl start nginx
            sudo systemctl enable nginx
          "


      - name: 'Clone Project Repository'
        run: |
          ssh -o StrictHostKeyChecking=no -i hng_devops.pem ubuntu@${{ secrets.FRONTEND_PUBLIC_IP }} "
            echo "Cloning Project Repo"
             echo "Cloning application repository"
            git clone https://github.com/iamDayoDev/terraform-aws-ec2-finbloom-app.git || echo "Repository already cloned"
            cd "${REPO_DIR}"
            "
           

      - name: Configure Nginx Configure
        run: |
          ssh -o StrictHostKeyChecking=no -i hng_devops.pem ubuntu@${{ secrets.FRONTEND_PUBLIC_IP }} "
            echo "Configure Nginx for Frontend"
            cd $FRONTEND_DIR
            echo "Configuring Nginx"
            sudo cp frontend.conf /etc/nginx/sites-available/frontend.conf
            sudo ln -s /etc/nginx/sites-available/frontend.conf /etc/nginx/sites-enabled/frontend.conf
            sudo rm /etc/nginx/sites-enabled/default
            sudo nginx -t
            sudo systemctl reload nginx
            "

      - name: 'Copy Application Files'
        run: |
          ssh -o StrictHostKeyChecking=no -i hng_devops.pem ubuntu@${{ secrets.FRONTEND_PUBLIC_IP }} "
            echo "Configure Nginx for Frontend"
            echo "Copying application files to Nginx directory"
            sudo mkdir -p /var/www/html/finbloom
            sudo cp -r $FRONTEND_DIR/* /var/www/html/finbloom/
            sudo chown -R www-data:www-data /var/www/html/finbloom
            sudo chmod -R 755 /var/www/html/finbloom
            sudo nginx -t
            sudo systemctl reload nginx
            "

      - name: Summary
        run: echo "### ðŸš€ Nginx Configured Successfully" >> $GITHUB_STEP_SUMMARY  

  